<!DOCTYPE html>
<html>
<head>
    <title>Labshop Admin Panel - Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .capture-box { border: 2px solid #007bff; background: #f0f7ff; }
        h1 { color: #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
        h3 { margin-top: 0; color: #007bff; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-refresh { background: #6c757d; color: white; margin-bottom: 10px; }
        .btn-logout { background: #f8f9fa; color: #d9534f; border: 1px solid #d9534f; width: auto; padding: 8px 15px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #666; font-size: 0.8em; text-transform: uppercase; }
        
        .debt-high { color: #d9534f; font-weight: bold; }
        .debt-zero { color: #999; font-style: italic; }
        #status_msg { font-weight: bold; display: block; margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #fff; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <h1>
        Labshop Manager Dashboard
        <button class="btn-logout" onclick="logout()">Logout</button>
    </h1>

    <div id="admin_greeting" style="margin-bottom: 20px; font-weight: bold; color: #555;"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
            <div class="card capture-box">
                <h3>Link IC Card</h3>
                <span id="status_msg">üîç Scanning for new card taps...</span>
                <div class="input-group">
                    <label>Detected UID:</label>
                    <input type="text" id="uid" readonly placeholder="Tap card on Reader 5...">
                </div>
                <div class="input-group">
                    <label>Assign to Student ID:</label>
                    <input type="number" id="link_sid">
                </div>
                <button class="btn-primary" onclick="registerCard()">Connect Card to Student</button>
            </div>

            <div class="card">
                <h3>Add New Student</h3>
                <div class="input-group"><label>Student ID:</label><input type="number" id="sid"></div>
                <div class="input-group"><label>First Name:</label><input type="text" id="fname"></div>
                <div class="input-group"><label>Last Name:</label><input type="text" id="lname"></div>
                <button class="btn-success" onclick="createUser()">Save New Student</button>
            </div>
        </div>

        <div>
            <div class="card">
                <h3>Live Student Debt List</h3>
                <div class="input-group">
                    <input type="text" id="studentSearch" placeholder="üîç Search Name or ID..." onkeyup="filterStudents()">
                </div>
                <button class="btn-refresh" onclick="loadUsers()">Manual Refresh</button>
                <table id="userTable">
                    <thead><tr><th>ID</th><th>Name</th><th>Debt</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="card" style="border-top: 4px solid #ffc107;">
                <h3>‚öôÔ∏è System Settings</h3>
                <div class="input-group">
                    <label>Maximum Debt Limit (¬•):</label>
                    <input type="number" id="max_debt_limit">
                </div>
                <button class="btn-primary" style="background: #ffc107; color: #333;" onclick="updateMaxDebt()">Update Limit</button>
            </div>

            <div class="card">
                <h3>Recent Activity</h3>
                <table id="activityTable">
                    <thead><tr><th>Time</th><th>Student</th><th>Type</th><th>Amount</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const getAdminHeaders = () => ({
            'Content-Type': 'application/json',
            'admin-id': localStorage.getItem('loggedAdminId'),
            'admin-name': localStorage.getItem('loggedAdminName')
        });
        

        if (!localStorage.getItem('loggedAdminId')) window.location.href = "login.html";

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        async function loadData() {
            document.getElementById('admin_greeting').innerText = "Logged in as: " + localStorage.getItem('loggedAdminName');
            await loadUsers();
            await loadActivity();
        }

        async function loadUsers() {
            try {
                const res = await fetch('/users/');
                const data = await res.json();
                const tbody = document.querySelector("#userTable tbody");
                
                tbody.innerHTML = data.users.map(u => {
                    const fullName = `${u.first_name || ''} ${u.last_name || ''}`.trim();
                    const debtClass = u.account_balance > 0 ? 'debt-high' : 'debt-zero';
                    return `<tr>
                        <td>${u.student_id}</td>
                        <td>${fullName}</td>
                        <td class="${debtClass}">¬•${u.account_balance}</td>
                    </tr>`;
                }).join('');
                filterStudents();
            } catch (e) { console.error("Load users failed", e); }
        }

        async function loadActivity() {
            try {
                const [pRes, payRes] = await Promise.all([fetch('/purchases/'), fetch('/payments/')]);
                const pData = (await pRes.json()).purchases || [];
                const payData = (await payRes.json()).payments || [];

                const all = [
                    ...pData.map(x => ({ time: x.created_at, id: x.student_id, type: 'PURCHASE', amount: x.price, color: '#d9534f' })),
                    ...payData.map(x => ({ time: x.created_at, id: x.student_id, type: 'PAYMENT', amount: x.amount_paid, color: '#28a745' }))
                ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 10);

                document.querySelector("#activityTable tbody").innerHTML = all.map(a => `
                    <tr>
                        <td>${new Date(a.time).toLocaleTimeString()}</td>
                        <td>ID: ${a.id}</td>
                        <td style="color: ${a.color}; font-weight: bold;">${a.type}</td>
                        <td>¬•${a.amount}</td>
                    </tr>
                `).join('');
            } catch (e) { console.error("Activity load failed", e); }
        }

       async function createUser() {
    try {
        const res = await fetch('/users/', {
            method: 'POST',
            headers: getAdminHeaders(),
            body: JSON.stringify({
                student_id: parseInt(document.getElementById('sid').value),
                first_name: document.getElementById('fname').value,
                last_name: document.getElementById('lname').value
            })
        });

        if (res.ok) { 
            alert("Student Created!"); 
            loadData(); 
            document.getElementById('sid').value = "";
            document.getElementById('fname').value = "";
            document.getElementById('lname').value = "";
        } else {
            const errorData = await res.json();
            alert("Error: " + (errorData.detail || "Could not create student"));
        }
    } catch (err) {
        console.error(err);
        alert("Network Error: Please check if the server is running.");
    }
}
        async function registerCard() {
            const res = await fetch('/register_card/', {
                method: 'POST',
                headers: getAdminHeaders(),
                body: JSON.stringify({
                    uid: document.getElementById('uid').value,
                    student_id: parseInt(document.getElementById('link_sid').value),
                    admin_id: localStorage.getItem('loggedAdminId'),
                    admin_name: localStorage.getItem('loggedAdminName')
                })
            });
            if (res.ok) { 
                alert("Card Linked!"); 
                document.getElementById('uid').value = "";
                loadData(); 
            }
        }

        async function updateMaxDebt() {
    const element = document.getElementById('max_debt_limit');
    
    if (!element) {
        console.error("Could not find an HTML element with id='max_debt_limit'");
        return;
    }

    const val = element.value;

    if (!val) {
        alert("Please enter a limit");
        return;
    }

    try {
        const res = await fetch('/system_settings/', {
            method: 'POST',
            headers: getAdminHeaders(),
            body: JSON.stringify({ 
                key: "max_debt_limit", 
                value: String(val) 
            })
        });

        if (res.ok) {
            alert("Limit Updated to ¬•" + val);
        } else {
            const errData = await res.json();
            alert("Server Error: " + (errData.detail || "Update failed"));
        }
    } catch (err) {
        alert("Connection failed. Is the server running?");
    }
}

        function filterStudents() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            document.querySelectorAll("#userTable tbody tr").forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(query) ? "" : "none";
            });
        }

        async function pollForNewCard() {
            const res = await fetch('/get_captured_card/');
            const data = await res.json();
            if (data && data.uid) {
                document.getElementById('uid').value = data.uid;
                document.getElementById('status_msg').innerText = "New Card: " + data.uid;
            }
        }

        window.onload = loadData;
        setInterval(pollForNewCard, 2000);
        setInterval(loadData, 10000);
    </script>
</body>
</html>